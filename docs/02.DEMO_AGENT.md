# 🎬 02.DEMO_AGENT.md（CODEX用 仕様ドキュメント）

> 本仕様は 01.DEMO_PLANNER.md の合意内容をもとに生成されています（Twilio Verify Passkey on Vercel/Next.js、OTPフォールバック: Twilio Verify）。

---

## 🧠 Project Overview
- Project Name: 証券Webログイン パスキーデモ（Booth）
- Demo Type: Scenario-driven
- Target Audience: 展示会ブース来場者（非技術/事業/経営層を含む広範）
- Expected Wow: Experiential（体験）/ Conceptual（発想）/ Mild（簡単さ）
- Core Purpose (1 sentence): パスキーによるID/パスワードレス認証の「簡単さ」と「高いセキュリティ」を数秒の体験で直感的に理解させ、商談化につなげる

---

## 🧩 Technical Context
- Platform: Vercel（Next.js、Serverless/Edge）
- APIs / Services:
  - Twilio Verify Passkey（ベータ）… Passkey（WebAuthn）認証の中核
  - Twilio Verify（OTP: SMS/Email）… フォールバック（非対応端末/失敗時）
- Frontend: Next.js（App Router、React。UIはTailwind任意）、QR表示/比較パネル/リセットUI
- Backend: Next.js Route Handlers（Serverless/Edge選択）、セッションは短期クッキー/ストレージ
- Data Handling: PII保存なし（デモユーザ/ダミーデータのみ）。匿名メトリクス（成功/失敗/所要時間/クリック数）
- Constraints / NFRs:
  - 体感速度: 「ログインクリック→ダッシュボード表示」2秒以内（良回線時）
  - 回転率: 1体験30〜60秒、リセットは1クリック/5秒以内
  - 安定性: APIタイムアウト≥10s、指数バックオフ、無状態化で同時実行に耐性
  - セキュリティ: HTTPS必須、RP IDは展示用ドメイン固定、Origin厳密チェック
  - 会場ネット変動対策: CDN配信、軽量モード（画像圧縮/固定データ）

---

## 🗺️ System Architecture

### 1) Mermaid 構成図
~~~mermaid
flowchart LR
  User((Booth Visitor))
  subgraph Device[Visitor Device]
    Browser[Browser UI (Next.js)]
  end

  subgraph Vercel[Vercel]
    App[Next.js App (App Router)]
    API[API Routes (Serverless/Edge)]
    CDN[(Edge Network/CDN)]
    Metrics[Vercel Analytics / Logs]
  end

  subgraph Twilio[Twilio]
    Passkey[Verify Passkey (Beta)]
    OTP[Verify OTP (SMS/Email)]
  end

  User --> Browser
  Browser <--> CDN
  CDN <--> App
  App <--> API
  API <--> Passkey
  API <--> OTP
  App --> Metrics
  API --> Metrics

  classDef svc fill:#eef,stroke:#99f;
  classDef ext fill:#efe,stroke:#6c6;

  class App,API,CDN,Metrics svc
  class Passkey,OTP ext
~~~

### 2) 主フロー（時系列）
1. 来場者がデモサイトにアクセス、ホームで「パスキーでログイン」をクリック
2. APIがTwilio Verify Passkeyでチャレンジ開始（WebAuthnパラメータを返却）
3. ブラウザが生体認証（Face/Touch ID/PIN）で署名生成→API検証→セッション確立
4. ダッシュボードへ遷移、成功トースト＋所要時間メータ表示
5. スタッフが「従来方式との比較」パネルを提示（クリック数/入力数/所要時間の比較）
6. リセットボタンでサインアウト＆状態初期化（次の来場者へ）
7. 追加デモ（任意）: クロスデバイス承認（PCでQR→スマホ承認→PCでログイン完了）

---

## 🎨 UX / UI
- UI Mood: シンプル・直感・大きなコールトゥアクション（会場でも視認性高）
- Key Screens / States:
  - ホーム（パスキーでログイン、従来方式の比較導線、クロスデバイスQR）
  - 生体認証待機モーダル（数秒以内のスピナー＋ヒント）
  - ダッシュボード（ポートフォリオ例、成功トースト、所要時間表示）
  - 比較パネル（ID+PW+SMSとの手順比較、クリック/打鍵数/時間）
  - リセット確認（1クリックで初期化）
- Accessibility / Mobile:
  - 大きめボタン、コントラスト確保
  - iOS/Android双方のWebAuthn（Passkey）対応、QR許可誘導

---

## 💥 Wow Design
| Wow Type | 狙い | 実装ポイント |
|----------|------|--------------|
| Experiential | 数秒・2ステップでログイン完了 | 成功トーストと所要時間メータを即時表示 |
| Conceptual | 従来方式との摩擦差を直感可視化 | クリック/打鍵/所要時間の並列比較UI |
| Mild | 覚えなくていい・間違えない | 生体認証で完了、入力ゼロ。失敗時もOTPにワンタップ切替 |
| Visionary（任意） | クロスデバイスの未来感 | PC→QR→スマホ承認→PC完了の一連を60秒内で実演 |

---

## 🧰 Deliverables（AIが出力）
- [ ] アーキ図（Mermaid/PNG）
- [ ] コード一式（Next.js App Router + API Routes）
- [ ] Twilio連携実装（Verify Passkey Beta + Verify OTPフォールバック）
- [ ] `.env.example` と設定手順（RP設定/ドメイン/サービスSID）
- [ ] README（起動/デプロイ/セットアップ/ブース運用）
- [ ] デモ台本（1分/5分の2種）
- [ ] ブログ下書き（Qiita向け構成・見出し）

---

## 🔧 Implementation Notes

### Env Vars（例・名称は実サービス設定に準拠）
- TWILIO_ACCOUNT_SID
- TWILIO_AUTH_TOKEN
- TWILIO_VERIFY_SERVICE_SID（OTP用）
- TWILIO_VERIFY_PASSKEY_SERVICE_SID（Passkey用、ベータの実名に準拠）<!-- TBD: 正式キー名はベータ管理画面で確認 -->
- NEXT_PUBLIC_APP_BASE_URL（例: https://passkey-demo.example.com）
- RP_ID（例: passkey-demo.example.com）
- RP_NAME（例: Booth Passkey Demo）
- SESSION_SECRET（短期セッション用）

### Provisioning
- Vercel
  - 本番/プレビューのドメイン確定、環境変数の登録
  - Edge/Serverlessの割り当て（初期レスポンス低遅延を優先）
- Twilio
  - Verify（OTP）サービス作成（メッセージ送信元、文面に「デモ」を明記）
  - Verify Passkey（ベータ）を有効化、RP設定（ドメイン/Origin）
  - APIクレデンシャルのセキュア格納（Vercel Env）
- ブラウザ要件
  - 最新Chrome/Safari/Edge、iOS/AndroidのPasskey対応を確認
  - クロスデバイス（QR/ハンドオフ）デモの許可ダイアログ手順を整備

### Testing
- Preview環境（Vercel）でHTTPSのRP動作確認
- ローカル: localhostは「安全なオリジン」扱いだが、RP設定との整合を確認
- 生体認証成功/失敗、PIN fallback、OTP切替の各パスを通す
- ネット劣化時シミュレーション（リトライUI、軽量モード）

### Fallbacks
- ブラウザ非対応/認証失敗 → 自動でOTP（Twilio Verify）導線を提示
- 生体不可 → PIN fallback（WebAuthn範囲）→ それでも不可ならOTP
- QR許可NG → 同一端末のパスキー手順に切替
- 設定不一致（RP/Origin） → 明示エラー＋運用手順カード（Vercel/Twilioの両方修正）

### Metrics / Logging
- 匿名で成功/失敗/所要時間/クリック数を収集
- 主要KPI可視化（完走率 ≥ 90%、中央値時間、OTP発動率 等）
- Vercel Analytics/Logs活用、プライバシー配慮（PII非保存）

---

## 📜 Compliance / Legal
- PII非保存（デモユーザ/ダミーデータのみ）。ログは匿名化
- OTP文面に「デモ用途」の明記（国際SMSの規制に留意）
- 表記: 「Twilio Verify Passkey（ベータ）」の注記、実運用時の要件差はディスクレーマーで補足

---

## 🗓️ Timeline
- T0（2025-10-20）: 仕様FIX
- T0+2（2025-10-22）: 単体パスキー（同一端末）実装・UI骨子
- T0+4（2025-10-24）: クロスデバイス承認・比較パネル・OTPフォールバック
- T0+5（2025-10-25）: 計測/ダッシュボード・リセット機構
- T0+6（2025-10-26）: 台本/安定化/軽負荷試験
- T0+7（2025-10-27）: 会場ドライリハ・最終チェック

---

## 🔄 Notes for CODEX（実装指針）
- Next.js App Routerで以下を用意
  - UI: Home（開始/比較/QR）、Auth待機、Dashboard、Reset
  - API Routes: auth/challenge（Passkey開始）, auth/verify（Passkey検証）, auth/otp/start, auth/otp/verify, session/reset, metrics/track
- ドメイン/RP/Originは環境変数で注入し、Vercel環境に同期
- Passkeyエラー時は即座にOTP導線を提示し、完走率を最優先
- 所要時間の計測（フロントで開始、成功時にAPIへ送信）を実装
- UIは大ボタン・短文コピー・アニメーション控えめ（会場回線でも軽快に）

---